<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Subway Tracker - Live</title>

    <!-- Favicon (subway emoji) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöá</text></svg>">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .status-bar {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.95;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .filter-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .filter-checkboxes {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Custom pretty checkbox styling */
        .filter-checkbox-item {
            position: relative;
        }

        .filter-checkbox-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .filter-checkbox-item .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            padding: 0 8px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .filter-checkbox-item .checkbox-label:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .filter-checkbox-item input[type="checkbox"]:checked + .checkbox-label {
            background: rgba(255, 255, 255, 0.9);
            border-color: white;
            color: #667eea;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .filter-checkbox-item input[type="checkbox"]:checked + .checkbox-label::before {
            content: '‚úì ';
            margin-right: 2px;
        }

        /* Special styling for All Lines checkbox */
        .filter-checkbox-item.all-lines .checkbox-label {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            font-weight: 700;
        }

        .filter-checkbox-item.all-lines input[type="checkbox"]:checked + .checkbox-label {
            background: rgba(255, 255, 255, 1);
            color: #764ba2;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .legend h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .route-123 { background-color: #EE352E; }
        .route-456 { background-color: #00933C; }
        .route-7 { background-color: #B933AD; }
        .route-ace { background-color: #0039A6; }
        .route-bdfm { background-color: #FF6319; }
        .route-g { background-color: #6CBE45; }
        .route-jz { background-color: #996633; }
        .route-l { background-color: #A7A9AC; }
        .route-nqrw { background-color: #FCCC0A; }
        .route-s { background-color: #808183; }

        /* Leaflet customization for cleaner look */
        .leaflet-control-attribution {
            font-size: 10px;
            background: rgba(255,255,255,0.7);
        }

        /* Credit footer */
        .credit {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.75rem;
            color: #666;
            text-align: right;
            line-height: 1.4;
        }

        .credit a {
            color: #667eea;
            text-decoration: none;
        }

        .credit a:hover {
            text-decoration: underline;
        }

        /* Error banner */
        .error-banner {
            background: #ef4444;
            color: white;
            padding: 1rem 2rem;
            display: none;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease;
        }

        .error-banner.show {
            display: flex;
        }

        .error-banner .error-icon {
            font-size: 1.5rem;
        }

        .error-banner .error-message {
            flex: 1;
        }

        .error-banner .error-message strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Train marker with external arrow */
        .train-marker-container {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .train-bubble {
            background-color: var(--train-color);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 10px;
            position: absolute;
            top: 9px;
            left: 9px;
            z-index: 2;
        }

        .train-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid var(--train-color);
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
            z-index: 1;
        }

        /* About button */
        .about-btn {
            position: absolute;
            top: 1rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .about-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .modal-content p {
            margin: 0.75rem 0;
            color: #666;
            line-height: 1.6;
        }

        .modal-content a {
            color: #667eea;
            text-decoration: none;
        }

        .modal-content a:hover {
            text-decoration: underline;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üöá NYC Subway Tracker</h1>
        <button class="about-btn" id="about-btn" title="About this project">‚ÑπÔ∏è</button>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator"></span>
                <span>Live</span>
            </div>
            <div class="status-item">
                <span id="train-count">0 trains</span>
            </div>
            <div class="status-item">
                <span id="last-update">Updating...</span>
            </div>
            <div class="filter-container">
                <span class="filter-label">Filter:</span>
                <div class="filter-checkboxes">
                    <div class="filter-checkbox-item all-lines">
                        <input type="checkbox" id="filter-all" value="all">
                        <label for="filter-all" class="checkbox-label">All</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-1" value="1" checked>
                        <label for="filter-1" class="checkbox-label">1</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-2" value="2">
                        <label for="filter-2" class="checkbox-label">2</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-3" value="3">
                        <label for="filter-3" class="checkbox-label">3</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-4" value="4">
                        <label for="filter-4" class="checkbox-label">4</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-5" value="5">
                        <label for="filter-5" class="checkbox-label">5</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-6" value="6">
                        <label for="filter-6" class="checkbox-label">6</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-7" value="7">
                        <label for="filter-7" class="checkbox-label">7</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-A" value="A" checked>
                        <label for="filter-A" class="checkbox-label">A</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-C" value="C">
                        <label for="filter-C" class="checkbox-label">C</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-E" value="E">
                        <label for="filter-E" class="checkbox-label">E</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-B" value="B">
                        <label for="filter-B" class="checkbox-label">B</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-D" value="D" checked>
                        <label for="filter-D" class="checkbox-label">D</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-F" value="F" checked>
                        <label for="filter-F" class="checkbox-label">F</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-M" value="M">
                        <label for="filter-M" class="checkbox-label">M</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-G" value="G">
                        <label for="filter-G" class="checkbox-label">G</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-J" value="J">
                        <label for="filter-J" class="checkbox-label">J</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-Z" value="Z">
                        <label for="filter-Z" class="checkbox-label">Z</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-L" value="L" checked>
                        <label for="filter-L" class="checkbox-label">L</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-N" value="N">
                        <label for="filter-N" class="checkbox-label">N</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-Q" value="Q">
                        <label for="filter-Q" class="checkbox-label">Q</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-R" value="R">
                        <label for="filter-R" class="checkbox-label">R</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-W" value="W">
                        <label for="filter-W" class="checkbox-label">W</label>
                    </div>
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-S" value="S">
                        <label for="filter-S" class="checkbox-label">S</label>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- About Modal -->
    <div class="modal" id="about-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">√ó</button>
            <h2>About NYC Subway Tracker</h2>
            <p><strong>What is this?</strong></p>
            <p>A real-time visualization of all NYC MTA subway trains, showing their current positions and directions on an interactive map.</p>

            <p><strong>How it works:</strong></p>
            <p>This app fetches live data from MTA's GTFS-RT feeds every 10 seconds and displays train positions at their next scheduled stops with directional indicators.</p>

            <p><strong>Created by:</strong></p>
            <p>Built by <strong>Aarif</strong> as a personal project to make NYC subway tracking more accessible and visually intuitive.</p>

            <p><strong>Data Source:</strong></p>
            <p>All real-time data provided by <a href="https://api.mta.info/" target="_blank">MTA</a>.</p>
        </div>
    </div>

    <div class="error-banner" id="error-banner">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-message">
            <strong>Data Collection Issue</strong>
            <span id="error-details">Unable to fetch real-time train data. Retrying...</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="legend">
        <h4>Routes</h4>
        <div class="legend-item">
            <div class="legend-icon route-123"></div>
            <span>1/2/3 Lines</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-456"></div>
            <span>4/5/6 Lines</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-7"></div>
            <span>7 Line</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-ace"></div>
            <span>A/C/E Lines</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-bdfm"></div>
            <span>B/D/F/M Lines</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-g"></div>
            <span>G Line</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-jz"></div>
            <span>J/Z Lines</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-l"></div>
            <span>L Line</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-nqrw"></div>
            <span>N/Q/R/W Lines</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon route-s"></div>
            <span>S (Shuttle)</span>
        </div>
        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e0e0e0;">
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #3b82f6; width: 10px; height: 10px;"></div>
                <span>Stations</span>
            </div>
        </div>
    </div>

    <div class="credit">
        built by aarif<br>
        data from <a href="https://api.mta.info/" target="_blank">MTA</a>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // MTA Official Colors
        const ROUTE_COLORS = {
            '1': '#EE352E', '2': '#EE352E', '3': '#EE352E',
            '4': '#00933C', '5': '#00933C', '6': '#00933C',
            '7': '#B933AD',
            'A': '#0039A6', 'C': '#0039A6', 'E': '#0039A6',
            'B': '#FF6319', 'D': '#FF6319', 'F': '#FF6319', 'M': '#FF6319',
            'G': '#6CBE45',
            'J': '#996633', 'Z': '#996633',
            'L': '#A7A9AC',
            'N': '#FCCC0A', 'Q': '#FCCC0A', 'R': '#FCCC0A', 'W': '#FCCC0A',
            'S': '#808183'
        };

        // All available routes
        const ALL_ROUTES = ['1', '2', '3', '4', '5', '6', '7', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'J', 'L', 'M', 'N', 'Q', 'R', 'S', 'W', 'Z'];

        // Active route filters - default to 1, A, F, D, L only
        let activeRoutes = new Set(['1', 'A', 'D', 'F', 'L']);

        // NYC Bounds (roughly)
        const nycBounds = L.latLngBounds(
            L.latLng(40.4774, -74.2591), // Southwest
            L.latLng(40.9176, -73.7004)  // Northeast
        );

        // Initialize map centered on NYC with minimalist style
        const map = L.map('map', {
            center: [40.7128, -73.9060],
            zoom: 12,
            minZoom: 11,
            maxZoom: 16,
            maxBounds: nycBounds,
            maxBoundsViscosity: 1.0
        });

        // Add CartoDB Positron tiles (minimalist, clean style)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        // Store markers
        let trainMarkers = {};
        let stationMarkers = {};
        let stationsLoaded = false;

        // Calculate bearing between two points
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;

            const œÜ1 = toRad(lat1);
            const œÜ2 = toRad(lat2);
            const ŒîŒª = toRad(lon2 - lon1);

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);

            const Œ∏ = Math.atan2(y, x);
            return (toDeg(Œ∏) + 360) % 360; // Normalize to 0-360
        }

        // Custom train icon with directional arrow
        const trainIcon = (route, train) => {
            const color = ROUTE_COLORS[route] || '#667eea';

            // Calculate bearing for arrow direction
            let bearing = 0;
            if (train.prev_position && train.position) {
                // Use previous position to current position
                bearing = calculateBearing(
                    train.prev_position.lat,
                    train.prev_position.lon,
                    train.position.lat,
                    train.position.lon
                );
            } else if (train.position && train.next_position) {
                // Use current position to next position
                bearing = calculateBearing(
                    train.position.lat,
                    train.position.lon,
                    train.next_position.lat,
                    train.next_position.lon
                );
            }

            // Position arrow outside the bubble based on bearing
            const arrowDistance = 15; // pixels from center
            const arrowX = Math.sin(bearing * Math.PI / 180) * arrowDistance;
            const arrowY = -Math.cos(bearing * Math.PI / 180) * arrowDistance;

            return L.divIcon({
                html: `
                    <div class="train-marker-container" style="--train-color: ${color};">
                        <div class="train-bubble">${route}</div>
                        <div class="train-arrow" style="
                            left: ${20 + arrowX}px;
                            top: ${20 + arrowY}px;
                            transform: translate(-50%, -50%) rotate(${bearing}deg);
                        "></div>
                    </div>
                `,
                className: 'train-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        };

        // Handle "All Lines" checkbox
        const allLinesCheckbox = document.getElementById('filter-all');
        allLinesCheckbox.addEventListener('change', function() {
            const routeCheckboxes = document.querySelectorAll('.filter-checkbox-item:not(.all-lines) input[type="checkbox"]');

            if (this.checked) {
                // Check all routes
                routeCheckboxes.forEach(cb => cb.checked = true);
                activeRoutes = new Set(ALL_ROUTES);
            } else {
                // Uncheck all routes
                routeCheckboxes.forEach(cb => cb.checked = false);
                activeRoutes.clear();
            }

            updateTrainVisibility();
        });

        // Route filter handler - attach to all checkboxes (except "All")
        document.querySelectorAll('.filter-checkbox-item:not(.all-lines) input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Update activeRoutes based on checked checkboxes
                activeRoutes.clear();
                document.querySelectorAll('.filter-checkbox-item:not(.all-lines) input[type="checkbox"]:checked').forEach(cb => {
                    activeRoutes.add(cb.value);
                });

                // Update "All Lines" checkbox state
                const allChecked = ALL_ROUTES.every(route => activeRoutes.has(route));
                allLinesCheckbox.checked = allChecked;

                // Re-render trains with filter
                updateTrainVisibility();
            });
        });

        // Update train visibility based on filter
        function updateTrainVisibility() {
            Object.entries(trainMarkers).forEach(([tripId, marker]) => {
                const train = marker._train;
                if (train && activeRoutes.has(train.route_id)) {
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map);
                    }
                } else {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                }
            });
        }

        // Load stations
        async function loadStations() {
            if (stationsLoaded) return;

            try {
                const response = await fetch('/api/stops');
                const data = await response.json();

                // Filter for relevant lines
                const relevantPrefixes = ['1', '2', '3', '4', '5', '6', '7', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'J', 'L', 'M', 'N', 'Q', 'R', 'S', 'W', 'Z'];

                data.stops.forEach(stop => {
                    // Check if stop_id starts with any relevant prefix
                    const isRelevant = relevantPrefixes.some(prefix =>
                        stop.stop_id.startsWith(prefix)
                    );

                    if (isRelevant) {
                        const marker = L.circleMarker([stop.lat, stop.lon], {
                            radius: 3,
                            fillColor: '#3b82f6',
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.6
                        }).addTo(map);

                        marker.bindPopup(`<b>${stop.name}</b><br><small>Stop ID: ${stop.stop_id}</small>`);
                        stationMarkers[stop.stop_id] = marker;
                    }
                });

                stationsLoaded = true;
                console.log('Loaded stations:', Object.keys(stationMarkers).length);
            } catch (error) {
                console.error('Error loading stations:', error);
            }
        }

        // Update trains on the map
        async function updateTrains() {
            try {
                const response = await fetch('/api/trains');
                const data = await response.json();

                // Update status bar
                document.getElementById('train-count').textContent = `${data.trains.length} trains`;
                if (data.last_updated) {
                    const updated = new Date(data.last_updated);
                    // Format in EST timezone
                    const estTime = updated.toLocaleTimeString('en-US', {
                        timeZone: 'America/New_York',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                    document.getElementById('last-update').textContent =
                        `Updated: ${estTime} EST ‚Ä¢ Refreshes every 15s`;
                }

                // Track existing train IDs
                const currentTrainIds = new Set();

                // Update train markers
                data.trains.forEach(train => {
                    currentTrainIds.add(train.trip_id);

                    if (train.position && train.position.lat && train.position.lon) {
                        const { lat, lon } = train.position;

                        // Create or update marker
                        if (trainMarkers[train.trip_id]) {
                            trainMarkers[train.trip_id].setLatLng([lat, lon]);
                            trainMarkers[train.trip_id].setIcon(trainIcon(train.route_id, train));
                            trainMarkers[train.trip_id]._train = train;
                        } else {
                            const marker = L.marker([lat, lon], {
                                icon: trainIcon(train.route_id, train)
                            });

                            marker._train = train;

                            // Only add if route is active
                            if (activeRoutes.has(train.route_id)) {
                                marker.addTo(map);
                            }

                            trainMarkers[train.trip_id] = marker;
                        }

                        // Update popup
                        const nextStop = train.stops[train.current_stop_index];
                        const directionText = train.direction_id === 0 ? 'Uptown/Bronx' : 'Downtown/Brooklyn';
                        const popupContent = `
                            <b>Route ${train.route_id}</b><br>
                            <small>Direction: ${directionText}</small><br>
                            <small>Next Stop: ${nextStop ? nextStop.stop_name : 'N/A'}</small><br>
                            <small>ETA: ${nextStop ? nextStop.arrival_time : 'N/A'}</small>
                        `;
                        trainMarkers[train.trip_id].bindPopup(popupContent);
                    }
                });

                // Remove markers for trains no longer in feed
                Object.keys(trainMarkers).forEach(tripId => {
                    if (!currentTrainIds.has(tripId)) {
                        map.removeLayer(trainMarkers[tripId]);
                        delete trainMarkers[tripId];
                    }
                });

            } catch (error) {
                console.error('Error updating trains:', error);
            }
        }

        // Health check function
        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                const errorBanner = document.getElementById('error-banner');
                const errorDetails = document.getElementById('error-details');

                // Show error if status is not 'ok' or if response is 503
                if (response.status !== 200 || data.status !== 'ok') {
                    errorBanner.classList.add('show');

                    if (data.reason) {
                        errorDetails.textContent = `${data.reason} - Data may be outdated or unavailable`;
                    } else {
                        errorDetails.textContent = 'Unable to fetch real-time train data. Retrying...';
                    }
                } else {
                    errorBanner.classList.remove('show');
                }
            } catch (error) {
                // Network error - show banner
                const errorBanner = document.getElementById('error-banner');
                const errorDetails = document.getElementById('error-details');
                errorBanner.classList.add('show');
                errorDetails.textContent = 'Cannot connect to server. Check your internet connection.';
            }
        }

        // Initialize
        loadStations();
        updateTrains();
        checkHealth();

        // Update trains every 15 seconds
        setInterval(updateTrains, 15000);

        // Check health every 30 seconds
        setInterval(checkHealth, 30000);

        // About modal functionality
        const aboutBtn = document.getElementById('about-btn');
        const aboutModal = document.getElementById('about-modal');
        const modalClose = document.getElementById('modal-close');

        aboutBtn.addEventListener('click', () => {
            aboutModal.classList.add('show');
        });

        modalClose.addEventListener('click', () => {
            aboutModal.classList.remove('show');
        });

        // Close modal when clicking outside
        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) {
                aboutModal.classList.remove('show');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && aboutModal.classList.contains('show')) {
                aboutModal.classList.remove('show');
            }
        });
    </script>
</body>
</html>
